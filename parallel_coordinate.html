<!DOCTYPE html>
<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Final Project - IV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

</head>

<body>
    <nav class="navbar  bg-primary navbar-expand-lg bg-body-tertiary " data-bs-theme="dark">
        <div class="container-fluid">
            <a class="navbar-brand mb-0 h1" href="#">THE GOAT DEBATE AND TEAM COMPARISION</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="treemap.html">Tree Map</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="top34.html">top 34</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="parallel_coordinate.html">Parallel Coordinate</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="timeseries.html">Time Series</a>
                    </li>
                    <li class="nav-item dropdown bg-danger">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            Team Members
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Rishi Vamshi Athinarap</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#">Anudeep Billa</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#">Sai Teja Avadhootha</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#">Sai Venkat Kumar Rapol</a></li>

                        </ul>
                    </li>
                </ul>
                <span class="navbar-text">
                    Information Visualisation - Group 6
                </span>
            </div>
        </div>
    </nav>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>
    <div class="tooltip" style="opacity: 0; position: absolute; pointer-events: none;"></div>

    <script type="module">
        import { preprocessData } from './dataset_preprocessing.js';

        function sortPlayersByEfficiency(players) {
            return players.sort((a, b) => b.Efficiency - a.Efficiency);
        }

        preprocessData((groupedPlayers) => {

            d3.csv("datasets/top75.csv").then(data => {
                const format = d3.format(".1f");

                data.forEach(player => {
                    player.PTS = parseFloat(format(player.PTS));
                    player.TRB = parseFloat(format(player.TRB));
                    player.AST = parseFloat(format(player.AST));
                    player.STL = parseFloat(format(player.STL));
                    player.BLK = parseFloat(format(player.BLK));

                    player.Efficiency = player.PTS + player.TRB + player.AST + player.STL + player.BLK;
                });

                const sortedData = sortPlayersByEfficiency(data);

                const combinedMap = new Map();
                sortedData.forEach(player => {
                    const playerName = player.Player;
                    if (groupedPlayers.has(playerName)) {
                        combinedMap.set(playerName, groupedPlayers.get(playerName));
                    }
                });

                console.log(combinedMap);

                const playerAttributeSums = new Map();

                combinedMap.forEach((seasons, playerName) => {
                    let attributeSums = {
                        PTS: 0,
                        TRB: 0,
                        AST: 0,
                        STL: 0,
                        BLK: 0,
                        TOV: 0,
                        FGA: 0,
                        FG: 0,
                        FTA: 0,
                        FT: 0
                    };

                    seasons.forEach(season => {
                        const gamesPlayed = parseFloat(season.G);
                        attributeSums.TRB += parseFloat(season.TRB) / gamesPlayed;
                        attributeSums.AST += parseFloat(season.AST) / gamesPlayed;
                        attributeSums.STL += parseFloat(season.STL) / gamesPlayed;
                        attributeSums.BLK += parseFloat(season.BLK) / gamesPlayed;
                        attributeSums.TOV += parseFloat(season.TOV) / gamesPlayed;
                        attributeSums.PTS += parseFloat(season.PTS) / gamesPlayed;
                        attributeSums.FGA += parseFloat(season.FGA) / gamesPlayed;
                        attributeSums.FG += parseFloat(season.FG) / gamesPlayed;
                        attributeSums.FTA += parseFloat(season.FTA) / gamesPlayed;
                        attributeSums.FT += parseFloat(season.FT) / gamesPlayed;

                    });

                    const numSeasons = seasons.length;
                    attributeSums.TRB /= numSeasons;
                    attributeSums.AST /= numSeasons;
                    attributeSums.STL /= numSeasons;
                    attributeSums.BLK /= numSeasons;
                    attributeSums.TOV /= numSeasons;
                    attributeSums.PTS /= numSeasons;
                    attributeSums.FGA /= numSeasons;
                    attributeSums.FG /= numSeasons;
                    attributeSums.FTA /= numSeasons;
                    attributeSums.FT /= numSeasons;

                    playerAttributeSums.set(playerName, attributeSums);


                });

                playerAttributeSums.forEach((attributeSums, playerName) => {
                    const basicPlayerScore = (attributeSums.PTS + attributeSums.TRB + attributeSums.AST + attributeSums.STL + attributeSums.BLK) - (attributeSums.FGA - attributeSums.FG + attributeSums.FTA - attributeSums.FT + attributeSums.TOV);
                    attributeSums.basicPlayerScore = basicPlayerScore;
                });

                console.log(playerAttributeSums);

                function getTopNPlayers(players, attribute, n) {
                    return [...players.entries()]
                        .sort((a, b) => b[1][attribute] - a[1][attribute])
                        .slice(0, n)
                        .map(([playerName, attributes]) => ({ name: playerName, value: attributes[attribute] }));
                }

                const top20PlayersByBasicPlayerScore = getTopNPlayers(playerAttributeSums, "basicPlayerScore", 10);

                console.log(top20PlayersByBasicPlayerScore);

                const finalMap = new Map();

                top20PlayersByBasicPlayerScore.forEach(player => {
                    const playerName = player.name;
                    if (playerAttributeSums.has(playerName)) {
                        finalMap.set(playerName, playerAttributeSums.get(playerName));
                    }
                });

                console.log("finalMap");
                console.log(finalMap);

                const margin = { top: 30, right: 10, bottom: 10, left: 10 },
                    width = 960 - margin.left - margin.right,
                    height = 500 - margin.top - margin.bottom;

                const svg = d3.select("body")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const dimensions = ["PTS", "TRB", "AST", "STL", "BLK", "TOV", "basicPlayerScore"];
                const y = {};

                dimensions.forEach(dimension => {
                    y[dimension] = d3.scaleLinear()
                        .domain(d3.extent([...finalMap.values()], player => player[dimension]))
                        .range([height, 0]);
                });

                const line = d3.line()
                    .defined(([, value]) => value != null)
                    .y(([dimension, value]) => y[dimension](value))
                    .x(([dimension]) => x(dimension));

                const x = d3.scalePoint()
                    .domain(dimensions)
                    .range([0, width])
                    .padding(1);

                svg.selectAll(".dimension")
                    .data(dimensions)
                    .enter()
                    .append("g")
                    .attr("class", "dimension")
                    .attr("transform", d => `translate(${x(d)})`)
                    .each(function (d) {
                        d3.select(this).append("g")
                            .attr("class", "axis")
                            .call(d3.axisLeft(y[d]));
                    })
                    .append("text")
                    .style("text-anchor", "middle")
                    .attr("y", -9)
                    .text(d => d);

                svg.selectAll(".line")
                    .data([...finalMap.entries()])
                    .enter()
                    .append("path")
                    .attr("class", "line")
                    .attr("d", ([, values]) => line(dimensions.map(dimension => [dimension, values[dimension]])))
                    .style("fill", "none")
                    .style("stroke", "steelblue")
                    .style("opacity", 0.7)
                    .style("stroke-width", 3);

                const highlight = (selectedLine) => {
                    d3.selectAll(".line")
                        .style("stroke", "lightgray")
                        .style("opacity", 0.2);
                    selectedLine
                        .style("stroke", "steelblue")
                        .style("opacity", 1);
                };

                const unhighlight = () => {
                    d3.selectAll(".line")
                        .style("stroke", "steelblue")
                        .style("opacity", 0.7);
                };

                const tooltip = d3.select(".tooltip");

                svg.selectAll(".line")
                    .on("mouseover", function (event, [playerName, values]) {
                        highlight(d3.select(this));

                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0.9);
                        tooltip.html(playerName)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function () {
                        unhighlight();
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            }).catch(error => {
                console.error("Error loading the dataset:", error);
            });

        });
    </script>
</body>

</html>